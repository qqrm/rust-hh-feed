name: Auto merge

on:
  workflow_run:
    workflows: ["CI Checks"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-merge-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  merge:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine PR number
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.workflow_run.pull_requests[0];
            if (pr) {
              const { data } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
              });
              const sameRepo =
                data.head.repo.full_name === `${context.repo.owner}/${context.repo.repo}`;
              core.setOutput('number', pr.number);
              core.setOutput('author', data.user.login);
              core.setOutput('same_repo', String(sameRepo));
            } else {
              core.setOutput('number', '');
              core.setOutput('author', '');
              core.setOutput('same_repo', 'false');
            }

      - name: Merge primary PR
        if: >
          steps.pr.outputs.number &&
          (steps.pr.outputs.author == 'codex-bot' || steps.pr.outputs.author == 'qqrm') &&
          steps.pr.outputs.same_repo == 'true'
        env:
          PR: ${{ steps.pr.outputs.number }}
        shell: bash
        run: |
          set -euo pipefail

          if ! gh pr merge "$PR" --rebase --delete-branch; then
            gh pr merge "$PR" --squash --delete-branch
          fi

      - name: Rebase and merge remaining PRs
        shell: bash
        run: |
          set -euo pipefail

          primary_pr="${{ steps.pr.outputs.number }}"
          primary_pr="${primary_pr:-}"

          for n in $(gh pr list --state open --json number -q '.[].number'); do
            if [ "$n" = "$primary_pr" ]; then
              continue
            fi

            author="$(gh pr view "$n" --json author -q '.author.login')"
            head_repo="$(gh pr view "$n" --json headRepository -q '.headRepository.nameWithOwner')"

            if [ "$author" != "codex-bot" ] && [ "$author" != "qqrm" ]; then
              continue
            fi

            if [ "$head_repo" != "$GITHUB_REPOSITORY" ]; then
              continue
            fi

            gh pr checkout "$n"
            git pull --rebase origin main || continue
            git push --force-with-lease

            if ! gh pr merge "$n" --rebase --delete-branch; then
              gh pr merge "$n" --squash --delete-branch || true
            fi
          done
