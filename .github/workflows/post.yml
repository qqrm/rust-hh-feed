name: Post to Telegram

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

concurrency:
  group: post-to-telegram-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    timeout-minutes: 20
    env:
      CARGO_TERM_PROGRESS_WHEN: never

    steps:
      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Download posted jobs state
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: post.yml
          name: posted_jobs
          path: data
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow_conclusion: success
          if_no_artifact_found: fail

      - name: Download release binary
        shell: bash
        env:
          BINARY_NAME: rust-hh-feed
        run: |
          set -euo pipefail
          curl -sSL -o "$BINARY_NAME" \
            "https://github.com/${{ github.repository }}/releases/latest/download/$BINARY_NAME"
          chmod +x "$BINARY_NAME"

      - name: Run bot
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MANUAL_MODE: ${{ github.event_name == 'workflow_dispatch' }}
          RUST_LOG: info
          BINARY_NAME: rust-hh-feed
        run: |
          set -euo pipefail
          "./$BINARY_NAME"

      - name: Upload posted jobs state
        uses: actions/upload-artifact@v4
        with:
          name: posted_jobs
          path: data/posted_jobs.json

      - name: Notify failure
        if: failure()
        shell: bash
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.DEV_TELEGRAM_CHAT_ID }}
        run: |
          set -euo pipefail
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="‚ùå Workflow '${{ github.workflow }}' failed. See https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  cleanup-old-runs:
    needs: run-bot
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      actions: write
    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const cutoff = Date.now() - 3 * 24 * 60 * 60 * 1000;
            const {owner, repo} = context.repo;

            const workflows = await github.paginate(
              github.rest.actions.listRepoWorkflows,
              {owner, repo}
            );

            for (const wf of workflows) {
              const runs = await github.paginate(
                github.rest.actions.listWorkflowRuns,
                {
                  owner,
                  repo,
                  workflow_id: wf.id,
                  status: 'completed'
                }
              );

              for (const run of runs) {
                if (Date.parse(run.updated_at) < cutoff) {
                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id
                  });
                }
              }
            }
